using System.Diagnostics;
using System.IO.Compression;
using CommunityToolkit.Maui.Storage;
using IWshRuntimeLibrary;

namespace GallowsGameInstaller.Pages;

public partial class InstallationPage : ContentPage
{
    Label labelProgressBarProcent;
    ProgressBar progressBar;
    public InstallationPage(string path)
    {
        InitializeComponent();
        ProgressBarInit();
        if (!string.IsNullOrEmpty(path))
        {
            //ExtractAndCopyFiles(@"D:\CSProjects\GallowsGameInstaller\GallowsGameInstaller\ProjectBuildFiles\GallowGame.zip", path);            
            ExtractAndCopyFiles(Environment.ExpandEnvironmentVariables(@"%USERPROFILE%\Desktop\GallowGame.zip"), path);
        }
    }
    public InstallationPage()
    {
        InitializeComponent();
        NavigationPage.SetHasBackButton(this, false); //убирает дефолтную кнопку возвращения на предыдущую страницу
        ProgressBarInit();
        ExtractAndCopyFiles(Environment.ExpandEnvironmentVariables(@"%USERPROFILE%\Desktop\GallowGame.zip"), @"C:\Program Files\GallowGame");
    }
    private void ProgressBarInit()
    {
        // Создайте ProgressBar
        progressBar = new ProgressBar
        {
            Progress = 0.5, // Установите начальное значение прогресса (0.5 для 50%)
            ProgressColor = Colors.Blue // Установите цвет прогресс-бара (например, синий)
        };
        labelProgressBarProcent = new Label();
        labelProgressBarProcent.Text = "0%";
        labelProgressBarProcent.TextColor = Colors.Black;

        Grid exitGrid = new Grid();
        Image exitImage = new Image();
        exitImage.Source = "thirdbttn.png";
        exitImage.WidthRequest = 130;

        Button exitButton = new Button();
        exitButton.Text = "Выйти";
        exitButton.WidthRequest = 130;

        exitGrid.Add(exitButton);
        exitGrid.Add(exitImage);
        // Создайте Grid для размещения ProgressBar по центру
        var grid = new Grid();
        grid.WidthRequest = 600;
        grid.HeightRequest = 50;
        grid.Children.Add(labelProgressBarProcent);
        grid.Children.Add(progressBar);
        grid.Children.Add(exitGrid);

        // Установите выравнивание по центру
        grid.HorizontalOptions = LayoutOptions.Center;
        grid.VerticalOptions = LayoutOptions.Center;

        // Добавьте grid на вашу страницу (например, MainPage)
        Content = grid;
    }

    private void ExtractAndCopyFiles(string relativeZipFilePath, string relativeDestinationFolderPath)
    {
        // Получаем текущую директорию пsроекта
        string projectDirectory = Directory.GetCurrentDirectory();

        // Формируем полный путь к архивному файлу и папке назначения
        string zipFilePath = Path.Combine(projectDirectory, relativeZipFilePath);
        string destinationFolderPath = Path.Combine(projectDirectory, relativeDestinationFolderPath);

        // Проверяем, существует ли архивный файл
        if (!System.IO.File.Exists(zipFilePath))
        {
            throw new FileNotFoundException($"Файл не найден: {zipFilePath}");
        }

        // Создаем папку назначения, если она не существует
        if (!Directory.Exists(destinationFolderPath))
        {
            Directory.CreateDirectory(destinationFolderPath);
        }

        // Создаем временную папку для извлечения файлов
        string tempFolderPath = Path.Combine(Path.GetTempPath(), Path.GetRandomFileName());
        Directory.CreateDirectory(tempFolderPath);

        try
        {
            // Разархивируем файлы во временную папку
            ZipFile.ExtractToDirectory(zipFilePath, tempFolderPath);

            // Проходимся по всем файлам во временной папке и копируем их в папку назначения
            var allFilesTempFolder = Directory.GetFiles(tempFolderPath, "*", SearchOption.AllDirectories);
            int tempFolderFilesCount = allFilesTempFolder.Count();
            int counter = 0;
            foreach (string filePath in allFilesTempFolder)
            {
                counter += 1;
                double shareReadiness = counter / tempFolderFilesCount;
                double shareReadinessRounded = Math.Round(shareReadiness, 1);
                MainThread.BeginInvokeOnMainThread(() =>
                {
                    progressBar.Progress = shareReadinessRounded;
                    labelProgressBarProcent.Text = (shareReadiness * 100).ToString() + "%";
                });

                // Определяем относительный путь файла от временной папки
                string relativePath = filePath.Substring(tempFolderPath.Length + 1);
                // Формируем полный путь к файлу в папке назначения
                string destinationPath = Path.Combine(destinationFolderPath, relativePath);

                // Убедимся, что директория назначения существует, и создаем её, если нет
                string destinationDir = Path.GetDirectoryName(destinationPath);
                if (!Directory.Exists(destinationDir))
                {
                    Directory.CreateDirectory(destinationDir);
                }

                // Копируем файл во временной папке в папку назначения
                System.IO.File.Copy(filePath, destinationPath, true);
                CreateShortcut(@"%USERPROFILE%\Desktop\GallowsGame.lnk", destinationDir + @"\GallowsGame.exe"); //Путь к новому ярлыку с name.lnk / путь к ИСПОЛНЯЕМОМУ файлу
            }
        }
        finally
        {
            // Удаляем временную папку и все её содержимое
            Directory.Delete(tempFolderPath, true);
        }
    }

    public static void CreateShortcut(string shortcutPath, string targetPath)
    {
        shortcutPath = Environment.ExpandEnvironmentVariables(shortcutPath);
        WshShell wshShell = new WshShell();
        IWshShortcut shortcut = (IWshShortcut)wshShell.CreateShortcut(shortcutPath);
        shortcut.TargetPath = targetPath;
        shortcut.Save();
    }
}